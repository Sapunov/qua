## Исправление ошибок при поиске


Система умеет исправлять 2 вида ошибок:
- неправильная раскладка клавиатуры;
- опечатки в запросе.

Причем за один поисковый запрос может быть исправлена ошибка **только одного типа.**

При исправлении опечаток за один поисковый запрос может быть исправлена ошибка
**только в одном слове**.


### Алгоритм коррекции ошибок

При поступлении запроса, он приводится к нижнему регистру и отправляется на
коррекцию ошибок. Коррекция ошибок состоит из 2 этапов. Если на первом этапе
была исправлена ошибка, то на второй этап запрос уже не попадает.

Этапы:

1. Исправление раскладки клавиатуры
2. Исправление опечаток


То есть сначала идет проверка на правильную раскладку клавиатуры, и, если она
правильная, идет проверка на опечатки.


#### Проверка на раскладку клавиатуры

Данная проверка выполняется следующим образом:

1. Создаются 2 переменные: одна с запросом пользователя, а вторая с запросов пользователя в инвертированной раскладке.
1. Выполяются 2 запроса к elasticsearch с политикой `OR` и по всем полям, доступным для поиска
1. Если количество результатов запроса с пользовательским вводом нулевое, а количество результатов с инвертированной раскладкой больше нуля, то пользовательский запрос заменяется на запрос, полученный от корректора и поиск продолжается уже по исправленному тексту


#### Проверка опечатов

Проверка опечаток выполняется с помощью поддерживаемого *elasticsearch* метода
`suggest`, который проверяет каждое слово во введенном предложении и предлагает
какие-либо опции. Алгоритм коррекции ошибок QUA берет самый вероятный вариант
исправления, предоставленный elasticsearch. За один раз может быть исправлено
только одно слово.


Если пользователю, по каким-либо причинам не нравится результат корректировки
ошибок, то нужно выполнить запрос к сервису *search* с GET-параметром **spelling=0**.
